<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Detective Notes</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#2f5ea8"/>
<style>
  :root{
    --blue:#2f5ea8;
    --blue2:#224b8d;
    --bg:#eaf2ff;
    --panel:#ffffff;
    --line:#9fb6d8;
    --text:#12304f;
    --muted:#567399;
    --good:#1f8a3b;
    --warn:#b07a00;
    --bad:#b11b1b;
  }
  *{box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  body{
    margin:0;
    background: linear-gradient(180deg, var(--blue), var(--blue2) 42%, var(--bg) 42%);
    color:var(--text);
  }
  header.top{
    padding:12px 14px 10px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    color:white;
  }
  .titleWrap{display:flex; flex-direction:column; gap:2px;}
  .titleWrap .h1{font-weight:900; font-size:22px; letter-spacing:.2px;}
  .btnRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
  button{
    border:2px solid rgba(255,255,255,.55);
    background:rgba(255,255,255,.12);
    color:white;
    font-weight:900;
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
  }
  button.primary{background:rgba(255,255,255,.18);}
  button.ghost{background:transparent;}
  button.danger{border-color:rgba(255,255,255,.55); background:rgba(255,255,255,.10);}
  main{
    padding:10px 10px 16px;
  }
  .card{
    max-width:780px;
    margin:0 auto;
    background:var(--panel);
    border:3px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    box-shadow: 0 16px 40px rgba(10,30,70,.18);
  }
  .tabs{
    display:flex;
    gap:10px;
    padding:10px;
    background: #f6faff;
    border-bottom:2px solid var(--line);
  }
  .tab{
    flex:1 1 0;
    height:44px;
    border-radius:12px;
    border:2px solid var(--line);
    background:white;
    color:var(--blue);
    font-weight:1000;
    font-size:16px;
  }
  .tab.active{
    background: linear-gradient(180deg, #3e73c4, var(--blue2));
    color:white;
    border-color:#1c3f74;
  }

  .playerHeader{
    display:grid;
    grid-template-columns: 30% repeat(5, 1fr);
    border-bottom:2px solid var(--line);
    background:#eef5ff;
  }
  .phCell{
    padding:8px 6px;
    font-weight:1000;
    font-size:12px;
    color:var(--muted);
    border-right:2px solid var(--line);
    text-align:center;
    line-height:1.05;
    white-space:normal;
  }
  .phCell:first-child{
    text-align:left;
    padding-left:12px;
    color:var(--blue);
  }
  .phCell.colDisabled{opacity:.4; background:#f3f5f7;}
  .sheet{
    overflow:hidden; /* user wanted no scrolling */
  }
  table{width:100%; border-collapse:collapse;}
  td{
    border-right:2px solid var(--line);
    border-bottom:2px solid var(--line);
    padding:6px 4px;
    font-size:13px;
  }
  td:first-child{width:30%; padding-left:12px; background:#f8fbff;}
  tr:last-child td{border-bottom:none;}
  .rowLabel{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    font-weight:1000;
    color:var(--blue);
  }
  .rowLabel .nameText.owned{ text-decoration:line-through; opacity:.7; color:#5b6f8e;}
  .pill{
    font-size:10px;
    font-weight:1000;
    color:#5b6f8e;
    border:1px solid var(--line);
    border-radius:999px;
    padding:2px 8px;
    background:white;
    white-space:nowrap;
  }
  .pill.solved{border-color:rgba(31,138,59,.5); background:rgba(31,138,59,.10); color:var(--good);}
  tr.ownedRow{opacity:.55;}
  tr.ownedRow td:first-child{background:#f1f1f1;}

  .cellBtn{
    width:100%;
    min-height:28px;
    border-radius:9px;
    border:2px solid var(--line);
    background:white;
    color:var(--text);
    font-weight:1000;
    padding:6px 0;
  }
  .cellBtn.x{background:rgba(177,27,27,.08); border-color:rgba(177,27,27,.35); color:var(--bad);}
  .cellBtn.check{background:rgba(31,138,59,.10); border-color:rgba(31,138,59,.35); color:var(--good);}
  .cellBtn.q{background:rgba(176,122,0,.10); border-color:rgba(176,122,0,.35); color:var(--warn);}
  .cellBtn:disabled{opacity:.35; background:#f3f5f7;}

  .banner{
    display:none;
    margin:10px;
    border:2px solid rgba(31,138,59,.35);
    background:rgba(31,138,59,.08);
    color:var(--good);
    font-weight:1000;
    border-radius:14px;
    padding:10px 12px;
  }

  .tray{
    border-top:2px solid var(--line);
    padding:10px;
    background:linear-gradient(180deg,#f6faff,#ffffff);
  }
  .trayTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;}
  .trayTop .t{font-weight:1000; color:var(--blue);}
  .trayGrid{display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
  .mini{
    border:2px solid var(--line);
    border-radius:14px;
    padding:8px;
    background:white;
    box-shadow:0 10px 18px rgba(20,60,120,.08);
  }
  .mini .k{font-size:10px; font-weight:1000; color:var(--muted);}
  .mini .v{font-size:12px; font-weight:1000; color:var(--text); margin-top:2px;}
  .thumb{
    margin-top:8px;
    width:100%;
    aspect-ratio:3/4;
    border:2px solid var(--line);
    border-radius:12px;
    background:linear-gradient(180deg,#ffffff,#f6faff);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:6px;
    text-align:center;
    font-weight:1000;
    color:var(--blue);
    font-size:11px;
    position:relative;
    overflow:hidden;
  }
  .thumb .cat{
    position:absolute; top:6px; left:6px;
    font-size:9px; font-weight:1000; color:var(--muted);
    background:white; border:1px solid var(--line);
    border-radius:999px; padding:2px 6px;
  }

  /* overlays */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:50;
  }
  .modal{
    width:min(820px, 100%);
    max-height: min(92vh, 860px);
    overflow:auto;
    background:white;
    border:3px solid var(--line);
    border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.22);
  }
  .modal header{
    position:sticky; top:0;
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    padding:12px 14px;
    color:white;
    background:linear-gradient(180deg,#3e73c4,var(--blue2));
    border-bottom:2px solid rgba(255,255,255,.25);
  }
  .modal header .h{font-size:18px; font-weight:1000;}
  .modal header .s{font-size:12px; opacity:.9; font-weight:800;}
  .modal header button{padding:8px 10px; border-radius:10px;}
  .modal .body{padding:12px 14px;}
  .row{display:flex; flex-wrap:wrap; gap:12px;}
  .field{flex:1 1 220px;}
  label{display:block; font-weight:1000; color:var(--muted); font-size:12px; margin-bottom:6px;}
  input, select{
    width:100%;
    border:2px solid var(--line);
    border-radius:12px;
    padding:10px 10px;
    font-weight:900;
    font-size:14px;
    outline:none;
  }
  .foot{
    display:flex; justify-content:flex-end; gap:10px;
    padding:12px 14px;
    border-top:2px solid var(--line);
    background:#f6faff;
    position:sticky; bottom:0;
  }
  .foot button{
    border-color:rgba(47,94,168,.35);
    background:white;
    color:var(--blue);
  }
  .foot button.primary{background:var(--blue); color:white; border-color:#1c3f74;}
  .foot button.danger{background:white; color:var(--bad); border-color:rgba(177,27,27,.35);}

  .choiceGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px;}
  .choice{
    border:2px solid var(--line);
    border-radius:14px;
    padding:10px;
    background:white;
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    font-weight:1000;
    color:var(--text);
  }

  .editPad{
    display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;
    margin-top:10px;
  }
  .editPad button{
    flex:1 1 120px;
    border:2px solid var(--line);
    background:white;
    color:var(--text);
    padding:12px 10px;
    border-radius:14px;
  }
  .editPad button.x{border-color:rgba(177,27,27,.35); color:var(--bad);}
  .editPad button.check{border-color:rgba(31,138,59,.35); color:var(--good);}
  .editPad button.q{border-color:rgba(176,122,0,.35); color:var(--warn);}
  .tinyNote{margin-top:10px; font-size:12px; font-weight:900; color:var(--muted);}

  @media (max-width:520px){
    header.top{padding:10px 12px;}
    .titleWrap .h1{font-size:20px;}
    button{padding:9px 10px; font-size:13px; border-radius:11px;}
    .trayGrid{grid-template-columns:repeat(3,1fr);}
    td:first-child{width:32%;}
    .phCell{font-size:11px;}
  }
</style>
</head>
<body>
<header class="top">
  <div class="titleWrap">
    <div class="h1">Detective Notes</div>
  </div>
  <div class="btnRow">
    <button class="primary" id="btnNewGame">New Game</button>
    <button class="primary" id="btnGuess">Guess</button>
    <button class="primary" id="btnMyCards">My Cards</button>
    <button class="ghost" id="btnPlayers">Players</button>
    <button class="ghost" id="btnLists">Lists</button>
    <button class="danger" id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="card">
    <div class="tabs">
      <button class="tab active" data-tab="people">WHO?</button>
      <button class="tab" data-tab="items">WHAT?</button>
      <button class="tab" data-tab="rooms">WHERE?</button>
    </div>

    <div class="banner" id="bannerSolved">You have discovered the solution based on your answers.</div>

    <div class="playerHeader" id="playerHeader"></div>

    <div class="sheet">
      <div id="tab-people"></div>
      <div id="tab-items" style="display:none"></div>
      <div id="tab-rooms" style="display:none"></div>
    </div>

    <div class="tray">
      <div class="trayTop">
        <div class="t">My Cards</div>
        <div class="tinyNote" style="margin:0;">(placeholders you can replace later)</div>
      </div>
      <div class="trayGrid" id="trayGrid"></div>
    </div>
  </div>
</main>

<!-- Players Modal -->
<div class="overlay" id="ovPlayers">
  <div class="modal">
    <header>
      <div>
        <div class="h">Players</div>
        <div class="s">Use 2–5 players. Don’t include yourself.</div>
      </div>
      <button id="closePlayers">Close</button>
    </header>
    <div class="body">
      <div class="row">
        <div class="field">
          <label>Active players</label>
          <select id="selActive">
            <option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option>
          </select>
        </div>
      </div>
      <div class="row" id="playerInputs"></div>
      <div class="tinyNote">Tip: unused columns are greyed out automatically.</div>
    </div>
    <div class="foot">
      <button class="primary" id="savePlayers">Save</button>
    </div>
  </div>
</div>

<!-- Lists Modal -->
<div class="overlay" id="ovLists">
  <div class="modal">
    <header>
      <div>
        <div class="h">Lists</div>
        <div class="s">Edit the names for WHO / WHAT / WHERE.</div>
      </div>
      <button id="closeLists">Close</button>
    </header>
    <div class="body">
      <div class="row">
        <div class="field">
          <label>WHO? (one per line)</label>
          <textarea id="taPeople" style="width:100%; min-height:140px; border:2px solid var(--line); border-radius:12px; padding:10px; font-weight:900;"></textarea>
        </div>
        <div class="field">
          <label>WHAT? (one per line)</label>
          <textarea id="taItems" style="width:100%; min-height:140px; border:2px solid var(--line); border-radius:12px; padding:10px; font-weight:900;"></textarea>
        </div>
        <div class="field">
          <label>WHERE? (one per line)</label>
          <textarea id="taRooms" style="width:100%; min-height:140px; border:2px solid var(--line); border-radius:12px; padding:10px; font-weight:900;"></textarea>
        </div>
      </div>
      <div class="tinyNote">Keep at least 1 in each list.</div>
    </div>
    <div class="foot">
      <button class="primary" id="saveLists">Save</button>
    </div>
  </div>
</div>

<!-- Guess Modal -->
<div class="overlay" id="ovGuess">
  <div class="modal">
    <header>
      <div>
        <div class="h">Make a guess</div>
        <div class="s">Pick WHO, WHAT, WHERE and who showed you a card.</div>
      </div>
      <button id="closeGuess">Close</button>
    </header>
    <div class="body">
      <div class="row">
        <div class="field"><label>WHO?</label><select id="gWho"></select></div>
        <div class="field"><label>WHAT?</label><select id="gWhat"></select></div>
        <div class="field"><label>WHERE?</label><select id="gWhere"></select></div>
      </div>
      <div class="row">
        <div class="field">
          <label>Who showed a card?</label>
          <select id="gResponder"></select>
          <div class="tinyNote" id="guessOwnedNote"></div>
        </div>
      </div>
    </div>
    <div class="foot">
      <button class="danger" id="clearGuess">Clear</button>
      <button class="primary" id="applyGuess">Apply</button>
    </div>
  </div>
</div>

<!-- Shown Modal -->
<div class="overlay" id="ovShown">
  <div class="modal">
    <header>
      <div>
        <div class="h">What was shown?</div>
        <div class="s">Pick the exact card they showed you.</div>
      </div>
      <button id="closeShown">Close</button>
    </header>
    <div class="body">
      <div class="field">
        <label>Card shown</label>
        <select id="shownPick"></select>
        <div class="tinyNote">If you don’t know which card, choose <b>Unknown</b> (adds ❓ to all 3).</div>
      </div>
    </div>
    <div class="foot">
      <button class="danger" id="shownUnknown">Unknown</button>
      <button class="primary" id="shownConfirm">Confirm</button>
    </div>
  </div>
</div>

<!-- My Cards Modal -->
<div class="overlay" id="ovMyCards">
  <div class="modal">
    <header>
      <div>
        <div class="h">My Cards</div>
        <div class="s">Select the cards you are holding (shows at the bottom).</div>
      </div>
      <button id="closeMyCards">Close</button>
    </header>
    <div class="body">
      <div class="row">
        <div class="field">
          <label>WHO?</label>
          <div class="choiceGrid" id="mcPeople"></div>
        </div>
        <div class="field">
          <label>WHAT?</label>
          <div class="choiceGrid" id="mcItems"></div>
        </div>
        <div class="field">
          <label>WHERE?</label>
          <div class="choiceGrid" id="mcRooms"></div>
        </div>
      </div>
      <div class="tinyNote">Anything you select becomes <b>MY CARD</b> and is ignored for “No one”.</div>
    </div>
    <div class="foot">
      <button class="danger" id="mcClear">Clear</button>
      <button class="primary" id="mcSave">Save</button>
    </div>
  </div>
</div>

<!-- Edit Cell Modal -->
<div class="overlay" id="ovEdit">
  <div class="modal" style="max-width:520px;">
    <header>
      <div>
        <div class="h">Mark cell</div>
        <div class="s" id="editSubtitle">Choose X, ✓, ?, or clear.</div>
      </div>
      <button id="closeEdit">Close</button>
    </header>
    <div class="body">
      <div class="editPad">
        <button class="x" id="setX">❌ X</button>
        <button class="check" id="setCheck">✅ ✓</button>
        <button class="q" id="setQ">❓ ?</button>
        <button id="setClear">Clear</button>
      </div>
      <div class="tinyNote">If you set ✓ on a card, this app auto-fills X on the rest of that row and greys it out.</div>
    </div>
  </div>
</div>

<script>
const LS_KEY="clue_sheet_v8_state";

const DEFAULT = {
  activePlayers: 5,
  players: ["Player 1","Player 2","Player 3","Player 4","Player 5"],
  lists: {
    people:["Green","Mustard","Orchid","Peacock","Plum","Scarlett"],
    items:["Candlestick","Dagger","Lead Pipe","Revolver","Rope","Wrench"],
    rooms:["Ballroom","Billiard Room","Conservatory","Dining Room","Hall","Kitchen","Library","Lounge","Study"]
  },
  marks:{ people:[], items:[], rooms:[] }, // 0 blank, 1 X, 2 check, 3 ?
  myCards:{ people:[], items:[], rooms:[] }
};

let state = loadState();

function escapeHtml(s){return (s??"").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));}
function makeThumb(cat, name){
  const label = escapeHtml(name);
  const catLabel = (cat||"").toUpperCase();
  const catPill = catLabel ? `<div class="cat">${escapeHtml(catLabel)}</div>` : "";
  return `<div class="thumb">${catPill}${label}</div>`;
}
function ensureMarks(){
  for(const sec of ["people","items","rooms"]){
    const rows = state.lists[sec].length;
    if(!Array.isArray(state.marks[sec])) state.marks[sec]=[];
    for(let r=0;r<rows;r++){
      if(!Array.isArray(state.marks[sec][r])) state.marks[sec][r]=[0,0,0,0,0];
      while(state.marks[sec][r].length<5) state.marks[sec][r].push(0);
    }
  }
}
function isOwnedRow(sec, rIdx){
  const name = state.lists[sec][rIdx];
  if((state.myCards[sec]||[]).includes(name)) return true;
  for(let p=0;p<state.activePlayers;p++){
    if(state.marks[sec][rIdx][p]===2) return true;
  }
  return false;
}
function applyMyCardsOwnership(){
  for(const sec of ["people","items","rooms"]){
    for(let r=0;r<state.lists[sec].length;r++){
      const name = state.lists[sec][r];
      if((state.myCards[sec]||[]).includes(name)){
        for(let p=0;p<state.activePlayers;p++) state.marks[sec][r][p]=1;
      }
    }
  }
}
function computeSolved(sec){
  const solved=[];
  for(let r=0;r<state.lists[sec].length;r++){
    if(isOwnedRow(sec,r)) continue;
    let allX=true;
    for(let p=0;p<state.activePlayers;p++){
      if(state.marks[sec][r][p]!==1){allX=false;break;}
    }
    if(allX) solved.push(r);
  }
  return solved;
}
function markToText(v){ return v===1?"X":v===2?"✓":v===3?"?":""; }
function markClass(v){ return v===1?"x":v===2?"check":v===3?"q":""; }

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) { const s=structuredClone(DEFAULT); ensureMarks.call({}); return structuredClone(DEFAULT); }
    const obj=JSON.parse(raw);
    const s=structuredClone(DEFAULT);
    // merge safe
    if(obj && typeof obj==="object"){
      if([2,3,4,5].includes(Number(obj.activePlayers))) s.activePlayers=Number(obj.activePlayers);
      if(Array.isArray(obj.players)) s.players = obj.players.slice(0,5).concat(["","","","",""]).slice(0,5).map((x,i)=>x||DEFAULT.players[i]);
      if(obj.lists && typeof obj.lists==="object"){
        for(const k of ["people","items","rooms"]){
          if(Array.isArray(obj.lists[k]) && obj.lists[k].length) s.lists[k]=obj.lists[k];
        }
      }
      if(obj.marks && typeof obj.marks==="object") s.marks=obj.marks;
      if(obj.myCards && typeof obj.myCards==="object") s.myCards=obj.myCards;
    }
    state=s;
    ensureMarks();
    return state;
  }catch{
    const s=structuredClone(DEFAULT);
    ensureMarks();
    return s;
  }
}

function renderHeader(){
  const ph=document.getElementById("playerHeader");
  const cells=[];
  cells.push(`<div class="phCell">PLAYERS</div>`);
  for(let i=0;i<5;i++){
    const disabled = i>=state.activePlayers;
    const name = state.players[i] || `Player ${i+1}`;
    cells.push(`<div class="phCell ${disabled?"colDisabled":""}">${escapeHtml(name)}</div>`);
  }
  ph.innerHTML=cells.join("");
}

function renderSection(sec){
  const solvedMain = (()=>{ const s=computeSolved(sec); return s.length===1 ? s[0] : null; })();
  let h=`<table><tbody>`;
  state.lists[sec].forEach((name,rIdx)=>{
    const mine = (state.myCards[sec]||[]).includes(name);
    // if someone checked it, fill X others
    let hasCheck=false;
    for(let p=0;p<state.activePlayers;p++){
      if(state.marks[sec][rIdx][p]===2){hasCheck=true;break;}
    }
    if(mine){
      for(let p=0;p<state.activePlayers;p++) state.marks[sec][rIdx][p]=1;
    }
    if(hasCheck){
      for(let p=0;p<state.activePlayers;p++){
        if(state.marks[sec][rIdx][p]!==2) state.marks[sec][rIdx][p]=1;
      }
    }

    const owned = mine || hasCheck;
    const isFound = (solvedMain!==null && solvedMain===rIdx);
    const trCls = (owned?"ownedRow ":"") + (isFound?"foundRow ":"");
    const nameCls = "nameText" + (owned?" owned":"");
    h+=`<tr class="${trCls.trim()}">`;
    h+=`<td><div class="rowLabel"><span class="${nameCls}">${escapeHtml(name)}</span>`+
       `${isFound?`<span class="pill solved">SOLVED</span>`:""}`+
       `${owned?`<span class="pill">${mine?"MY CARD":"OWNED"}</span>`:""}`+
       `</div></td>`;
    for(let p=0;p<5;p++){
      const disabled=p>=state.activePlayers;
      const v=state.marks[sec][rIdx][p]||0;
      h+=`<td><button class="cellBtn ${markClass(v)}" ${disabled?"disabled":""}`+
         ` data-sec="${sec}" data-row="${rIdx}" data-player="${p}">${markToText(v)}</button></td>`;
    }
    h+=`</tr>`;
  });
  h+=`</tbody></table>`;
  return h;
}

function renderTray(){
  const tray=document.getElementById("trayGrid");
  const cards=[];
  for(const n of state.myCards.people||[]) cards.push({k:"WHO", sec:"people", v:n});
  for(const n of state.myCards.items||[]) cards.push({k:"WHAT", sec:"items", v:n});
  for(const n of state.myCards.rooms||[]) cards.push({k:"WHERE", sec:"rooms", v:n});

  if(!cards.length){
    tray.innerHTML = `<div class="tinyNote">No cards selected yet. Tap <b>My Cards</b> or <b>New Game</b>.</div>`;
    return;
  }
  tray.innerHTML = cards.map(c=>`
    <div class="mini">
      <div class="k">${escapeHtml(c.k)}</div>
      <div class="v">${escapeHtml(c.v)}</div>
      ${makeThumb(c.k, c.v)}
    </div>
  `).join("");
}

function renderSolvedBanner(){
  const s1=computeSolved("people");
  const s2=computeSolved("items");
  const s3=computeSolved("rooms");
  const ok = (s1.length===1 && s2.length===1 && s3.length===1);
  const el=document.getElementById("bannerSolved");
  el.style.display = ok ? "block" : "none";
}

function renderAll(){
  ensureMarks();
  applyMyCardsOwnership();
  renderHeader();
  document.getElementById("tab-people").innerHTML=renderSection("people");
  document.getElementById("tab-items").innerHTML=renderSection("items");
  document.getElementById("tab-rooms").innerHTML=renderSection("rooms");
  renderTray();
  renderSolvedBanner();
  saveState();
}

function setTab(tab){
  document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  document.getElementById("tab-people").style.display = tab==="people" ? "" : "none";
  document.getElementById("tab-items").style.display = tab==="items" ? "" : "none";
  document.getElementById("tab-rooms").style.display = tab==="rooms" ? "" : "none";
}

// ---------- Modals ----------
const ovPlayers=document.getElementById("ovPlayers");
const ovLists=document.getElementById("ovLists");
const ovGuess=document.getElementById("ovGuess");
const ovShown=document.getElementById("ovShown");
const ovMyCards=document.getElementById("ovMyCards");
const ovEdit=document.getElementById("ovEdit");

function open(ov){ ov.style.display="flex"; }
function close(ov){ ov.style.display="none"; }

function openPlayers(){
  document.getElementById("selActive").value=String(state.activePlayers);
  const wrap=document.getElementById("playerInputs");
  wrap.innerHTML="";
  for(let i=0;i<5;i++){
    wrap.innerHTML += `<div class="field"><label>Player ${i+1}</label><input id="p_${i}" value="${escapeHtml(state.players[i]||"")}"/></div>`;
  }
  open(ovPlayers);
}
function savePlayers(){
  const n=Number(document.getElementById("selActive").value);
  state.activePlayers=Math.max(2,Math.min(5,n));
  const arr=[];
  for(let i=0;i<5;i++){
    const v=document.getElementById(`p_${i}`).value.trim();
    arr.push(v || `Player ${i+1}`);
  }
  state.players=arr;
  renderAll();
  close(ovPlayers);
}
function openLists(){
  document.getElementById("taPeople").value = (state.lists.people||[]).join("\n");
  document.getElementById("taItems").value  = (state.lists.items||[]).join("\n");
  document.getElementById("taRooms").value  = (state.lists.rooms||[]).join("\n");
  open(ovLists);
}
function saveLists(){
  const parse = (t)=> t.split("\n").map(x=>x.trim()).filter(Boolean);
  const p=parse(document.getElementById("taPeople").value);
  const i=parse(document.getElementById("taItems").value);
  const r=parse(document.getElementById("taRooms").value);
  if(!p.length||!i.length||!r.length) return;
  state.lists.people=p; state.lists.items=i; state.lists.rooms=r;
  // reset marks to fit new sizes
  state.marks={people:[],items:[],rooms:[]};
  ensureMarks();
  // clear my cards if names changed
  state.myCards={people:[],items:[],rooms:[]};
  renderAll();
  close(ovLists);
}

// Guess flow
let pendingGuess=null; // {whoIdx, whatIdx, whereIdx, player}
function fillGuessSelects(){
  const gWho=document.getElementById("gWho");
  const gWhat=document.getElementById("gWhat");
  const gWhere=document.getElementById("gWhere");
  gWho.innerHTML = state.lists.people.map(x=>`<option>${escapeHtml(x)}</option>`).join("");
  gWhat.innerHTML= state.lists.items.map(x=>`<option>${escapeHtml(x)}</option>`).join("");
  gWhere.innerHTML= state.lists.rooms.map(x=>`<option>${escapeHtml(x)}</option>`).join("");

  const resp=document.getElementById("gResponder");
  const opts=[`<option value="none">No one (solution)</option>`];
  for(let i=0;i<state.activePlayers;i++){
    opts.push(`<option value="${i}">${escapeHtml(state.players[i])}</option>`);
  }
  resp.innerHTML=opts.join("");
  updateGuessOwnedNote();
}
function updateGuessOwnedNote(){
  const who=document.getElementById("gWho").value;
  const what=document.getElementById("gWhat").value;
  const where=document.getElementById("gWhere").value;
  const owned=[];
  if((state.myCards.people||[]).includes(who)) owned.push("WHO is your card");
  if((state.myCards.items||[]).includes(what)) owned.push("WHAT is your card");
  if((state.myCards.rooms||[]).includes(where)) owned.push("WHERE is your card");
  document.getElementById("guessOwnedNote").textContent = owned.length ? ("Owned: "+owned.join(" • ")+" (ignored for “No one”)") : "";
}
function openGuess(){
  fillGuessSelects();
  open(ovGuess);
}
function clearGuess(){
  document.getElementById("gResponder").value="none";
}
function applyGuess(){
  const who=document.getElementById("gWho").value;
  const what=document.getElementById("gWhat").value;
  const where=document.getElementById("gWhere").value;
  const resp=document.getElementById("gResponder").value;

  const whoIdx=state.lists.people.indexOf(who);
  const whatIdx=state.lists.items.indexOf(what);
  const whereIdx=state.lists.rooms.indexOf(where);

  if(resp==="none"){
    const triples=[["people",whoIdx],["items",whatIdx],["rooms",whereIdx]];
    for(const [sec, idx] of triples){
      const name = state.lists[sec][idx];
      const mine = (state.myCards[sec]||[]).includes(name);
      if(mine){
        for(let p=0;p<state.activePlayers;p++) state.marks[sec][idx][p]=1;
        continue;
      }
      for(let p=0;p<state.activePlayers;p++) state.marks[sec][idx][p]=1;
    }
    renderAll();
    close(ovGuess);
    return;
  }

  pendingGuess={whoIdx, whatIdx, whereIdx, player:Number(resp)};
  const shown=document.getElementById("shownPick");
  shown.innerHTML = `
    <option value="unknown">Unknown</option>
    <option value="people">WHO: ${escapeHtml(state.lists.people[whoIdx])}</option>
    <option value="items">WHAT: ${escapeHtml(state.lists.items[whatIdx])}</option>
    <option value="rooms">WHERE: ${escapeHtml(state.lists.rooms[whereIdx])}</option>
  `;
  shown.value="unknown";
  open(ovShown);
}
function shownUnknown(){
  if(!pendingGuess) return;
  const p=pendingGuess.player;
  const setQ=(sec,idx)=>{ if(state.marks[sec][idx][p]===0) state.marks[sec][idx][p]=3; };
  setQ("people",pendingGuess.whoIdx);
  setQ("items",pendingGuess.whatIdx);
  setQ("rooms",pendingGuess.whereIdx);
  pendingGuess=null;
  renderAll();
  close(ovShown); close(ovGuess);
}
function shownConfirm(){
  if(!pendingGuess) return;
  const p=pendingGuess.player;
  const v=document.getElementById("shownPick").value;
  if(v==="unknown"){ shownUnknown(); return; }
  if(v==="people") state.marks.people[pendingGuess.whoIdx][p]=2;
  if(v==="items")  state.marks.items[pendingGuess.whatIdx][p]=2;
  if(v==="rooms")  state.marks.rooms[pendingGuess.whereIdx][p]=2;
  pendingGuess=null;
  renderAll();
  close(ovShown); close(ovGuess);
}

// My cards
function buildMyCards(){
  const build=(sec,root,label)=>{
    root.innerHTML = state.lists[sec].map(name=>{
      const checked=(state.myCards[sec]||[]).includes(name)?"checked":"";
      const cat= label;
      return `
        <label class="choice">
          <input type="checkbox" data-sec="${sec}" data-name="${escapeHtml(name)}" ${checked} style="width:18px;height:18px;">
          <span style="flex:1 1 auto;">${escapeHtml(name)}</span>
          <span style="width:56px; flex:0 0 auto;">${makeThumb(cat, name)}</span>
        </label>
      `;
    }).join("");
  };
  build("people", document.getElementById("mcPeople"), "WHO");
  build("items",  document.getElementById("mcItems"), "WHAT");
  build("rooms",  document.getElementById("mcRooms"), "WHERE");
}
function openMyCards(){
  buildMyCards();
  open(ovMyCards);
}
function mcSave(){
  const sel=(sec)=> Array.from(document.querySelectorAll(`#ovMyCards input[data-sec="${sec}"]:checked`)).map(cb=>cb.dataset.name);
  state.myCards={ people: sel("people"), items: sel("items"), rooms: sel("rooms") };
  renderAll();
  close(ovMyCards);
}
function mcClear(){
  state.myCards={people:[],items:[],rooms:[]};
  renderAll();
  close(ovMyCards);
}

// Edit cell
let editTarget=null; // {sec,row,player}
function openEdit(sec,row,player){
  editTarget={sec,row,player};
  document.getElementById("editSubtitle").textContent = `${sec.toUpperCase()} • ${state.lists[sec][row]} • ${state.players[player]}`;
  open(ovEdit);
}
function setMark(v){
  if(!editTarget) return;
  state.marks[editTarget.sec][editTarget.row][editTarget.player]=v;
  renderAll();
  close(ovEdit);
}

// New Game and Reset
function newGame(){
  // clear marks + my cards, keep players and lists
  state.marks={people:[],items:[],rooms:[]};
  ensureMarks();
  state.myCards={people:[],items:[],rooms:[]};
  renderAll();
  openMyCards();
}
function resetAll(){
  state=structuredClone(DEFAULT);
  ensureMarks();
  renderAll();
  openPlayers();
}

// events
document.addEventListener("click",(e)=>{
  const id=e.target?.id;
  if(id==="btnPlayers") openPlayers();
  if(id==="btnLists") openLists();
  if(id==="btnGuess") openGuess();
  if(id==="btnMyCards") openMyCards();
  if(id==="btnNewGame") newGame();
  if(id==="btnReset") resetAll();

  if(id==="closePlayers") close(ovPlayers);
  if(id==="savePlayers") savePlayers();
  if(id==="closeLists") close(ovLists);
  if(id==="saveLists") saveLists();
  if(id==="closeGuess") close(ovGuess);
  if(id==="clearGuess") clearGuess();
  if(id==="applyGuess") applyGuess();
  if(id==="closeShown") close(ovShown);
  if(id==="shownUnknown") shownUnknown();
  if(id==="shownConfirm") shownConfirm();
  if(id==="closeMyCards") close(ovMyCards);
  if(id==="mcSave") mcSave();
  if(id==="mcClear") mcClear();
  if(id==="closeEdit") close(ovEdit);
  if(id==="setX") setMark(1);
  if(id==="setCheck") setMark(2);
  if(id==="setQ") setMark(3);
  if(id==="setClear") setMark(0);

  const cell=e.target.closest(".cellBtn");
  if(cell && !cell.disabled){
    const sec=cell.dataset.sec;
    const row=Number(cell.dataset.row);
    const player=Number(cell.dataset.player);
    openEdit(sec,row,player);
  }

  const tabBtn=e.target.closest(".tab");
  if(tabBtn){ setTab(tabBtn.dataset.tab); }
});

["gWho","gWhat","gWhere"].forEach(id=>{
  document.getElementById(id).addEventListener("change", updateGuessOwnedNote);
});

// overlay click to close
[ovPlayers,ovLists,ovGuess,ovShown,ovMyCards,ovEdit].forEach(ov=>{
  ov.addEventListener("click",(e)=>{ if(e.target===ov) close(ov); });
});

// service worker
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw.js").catch(()=>{}));
}

ensureMarks();
renderAll();
</script>
</body>
</html>
