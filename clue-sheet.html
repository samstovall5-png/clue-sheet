<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clue Sheet (Digital)</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#2f5ea8">

  <style>
    :root{
      --blue:#2f5ea8;
      --blue2:#3b73c8;
      --blue3:#dbe9ff;
      --line:#8fb0e6;
      --paper:#ffffff;
      --text:#0b1b36;
      --muted:#385a8f;
      --danger:#d83a3a;
      --warn:#c08a00;
      --good:#167a2e;
      --shadow: 0 10px 26px rgba(20,60,120,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(180deg, #f7fbff, #eef5ff 55%, #f7fbff);
      color:var(--text);
    }

    /* Top bar */
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, var(--blue2), var(--blue));
      color:white;
      border-bottom:2px solid #244e8a;
      padding:12px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    header .title{font-weight:900; letter-spacing:.3px}
    header .sub{color:rgba(255,255,255,.85); font-size:12px}
    header .left{display:flex; flex-direction:column}
    header .right{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    button{
      border:1px solid rgba(255,255,255,.45);
      background:rgba(255,255,255,.14);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
    }
    button:hover{background:rgba(255,255,255,.22)}
    button.primary{
      background:rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.65);
    }
    button.danger{
      background:rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.65);
    }

    main{padding:14px; max-width:1100px; margin:0 auto}

    .banner{
      display:none;
      border:2px solid #2f7a3a;
      background:#eaf7ee;
      padding:12px 14px;
      border-radius:14px;
      margin:10px 0 14px 0;
      box-shadow: var(--shadow);
      color:var(--text);
    }
    .banner strong{color:var(--good)}

    .gridWrap{
      border:2px solid var(--line);
      border-radius:10px;
      overflow:hidden;
      background:var(--paper);
      box-shadow: var(--shadow);
    }

    .sectionHead{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:2px solid var(--line);
      background:linear-gradient(180deg, var(--blue3), #f5f9ff);
    }
    .sectionHead h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      color:var(--blue);
      font-weight:900;
    }
    .sectionHead .hint{color:var(--muted); font-size:12px; font-weight:700}

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    th, td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:10px 8px;
      text-align:center;
      font-size:14px;
      background:white;
    }
    th:last-child, td:last-child{border-right:none}
    th:first-child, td:first-child{
      text-align:left;
      padding-left:12px;
      width:34%;
      font-weight:800;
      color:var(--blue);
      background:#f6faff;
    }

    th{
      position:sticky; top:64px; z-index:5;
      background:linear-gradient(180deg, #d2e4ff, #f0f6ff);
      font-size:12px;
      color:var(--blue);
      font-weight:900;
      letter-spacing:.35px;
      border-bottom:2px solid var(--line);
    }

    tr:last-child td{border-bottom:none}

    .nameCell{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
      background:white;
      font-weight:900;
    }

    .cellBtn{
      width:100%;
      border-radius:6px;
      border:1px solid #b7cdf3;
      background:white;
      padding:10px 0;
      cursor:pointer;
      color:var(--blue);
      font-weight:900;
      letter-spacing:.4px;
      user-select:none;
    }
    .cellBtn:hover{background:#f4f8ff}

    .markX{color:var(--danger); border-color:#f0b2b2; background:#fff4f4}
    .markC{color:var(--good); border-color:#b7e1c1; background:#f0fbf3}
    .markQ{color:var(--warn); border-color:#f0d7a0; background:#fff9ea}

    /* Unused player columns */
    .colDisabled{
      background:#f0f0f0 !important;
      color:#9aa6b7;
    }
    .colDisabled .cellBtn{
      cursor:not-allowed;
      background:#f0f0f0;
      border-color:#d6dbe4;
      color:#9aa6b7;
    }
    .colDisabled .cellBtn:hover{background:#f0f0f0}

    /* Killer found highlighting (People section) */
    .foundRow td:first-child{
      outline:3px solid var(--good);
      outline-offset:-6px;
      border-radius:10px;
      background:#f0fbf3;
    }
    .foundRow td:first-child .pill{
      border-color:#2f7a3a;
      color:var(--good);
      background:#eaf7ee;
    }
    .greyOther{
      opacity:.45;
      filter:saturate(.65);
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0; background:rgba(22,50,95,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      background:white;
      border:2px solid var(--line);
      border-radius:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      background:linear-gradient(180deg, var(--blue2), var(--blue));
      border-bottom:2px solid #244e8a;
    }
    .modal header .title{color:white}
    .modal header .sub{color:rgba(255,255,255,.85)}
    .modalBody{padding:14px}
    .row{
      display:flex; gap:12px; flex-wrap:wrap; margin:10px 0;
      align-items:flex-start;
    }
    .field{
      flex:1 1 220px;
      background:#f5f9ff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:900}
    input, textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:white;
      color:var(--text);
      outline:none;
      font-size:14px;
      font-weight:700;
    }
    textarea{min-height:130px; resize:vertical}
    .modalFoot{
      padding:12px 14px;
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      border-top:2px solid var(--line);
      background:#f6faff;
    }
    .modalFoot button{
      color:var(--blue);
      background:white;
      border:2px solid var(--line);
    }
    .modalFoot button:hover{background:#f4f8ff}
    .modalFoot button.primary{border-color:var(--blue); color:var(--blue)}
    .modalFoot button.danger{border-color:#d83a3a; color:#d83a3a}

    /* Cell Edit Popup */
    .popup{
      position:fixed; inset:0;
      display:none; align-items:flex-end; justify-content:center;
      z-index:60;
      background:rgba(22,50,95,.35);
      padding:14px;
    }
    .popupCard{
      width:min(520px, 100%);
      border-radius:14px;
      border:2px solid var(--line);
      background:white;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .popupTop{
      padding:12px 14px;
      border-bottom:2px solid var(--line);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      background:linear-gradient(180deg, var(--blue3), #f5f9ff);
    }
    .popupTop .meta{display:flex; flex-direction:column; gap:2px}
    .popupTop .meta .small{color:var(--muted); font-size:12px; font-weight:800}
    .popupTop button{
      color:var(--blue);
      background:white;
      border:2px solid var(--line);
    }

    .popupBtns{
      display:grid; grid-template-columns:repeat(2, 1fr);
      gap:10px; padding:14px;
    }
    .bigBtn{
      padding:14px 12px; border-radius:12px; border:2px solid var(--line);
      background:white;
      cursor:pointer; font-size:16px; font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      color:var(--blue);
    }
    .bigBtn:hover{background:#f4f8ff}
    .bigX{color:var(--danger); border-color:#f0b2b2; background:#fff4f4}
    .bigC{color:var(--good); border-color:#b7e1c1; background:#f0fbf3}
    .bigQ{color:var(--warn); border-color:#f0d7a0; background:#fff9ea}
    .bigClr{color:var(--blue)}
    .popupFoot{
      padding:12px 14px; border-top:2px solid var(--line);
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      background:#f6faff;
    }
    .popupFoot button{
      color:var(--blue);
      background:white;
      border:2px solid var(--line);
    }
    .popupFoot button.danger{border-color:#d83a3a; color:#d83a3a}
    .popupFoot button:hover{background:#f4f8ff}

    @media (max-width:520px){
      th:first-child, td:first-child{width:44%}
      header .sub{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div class="title">Detective Notes</div>
      <div class="sub">Tap a box → choose ❌ / ✅ / ❓. Unused player columns turn grey.</div>
    </div>
    <div class="right">
      <button class="primary" id="btnSetup">Players</button>
      <button id="btnEditLists">Lists</button>
      <button class="danger" id="btnResetMarks">Reset</button>
    </div>
  </header>

  <main>
    <div class="banner" id="banner">
      <div><strong>✅ You have discovered the killer based on your answers.</strong></div>
      <div style="color:var(--muted); font-size:12px; margin-top:4px;">
        (A person row became ❌ for all active players.)
      </div>
    </div>

    <div class="gridWrap" id="wrapPeople"></div>
    <div style="height:14px"></div>
    <div class="gridWrap" id="wrapItems"></div>
    <div style="height:14px"></div>
    <div class="gridWrap" id="wrapRooms"></div>
  </main>

  <!-- Setup Modal -->
  <div class="overlay" id="overlaySetup">
    <div class="modal">
      <header>
        <div class="left">
          <div class="title">Players</div>
          <div class="sub">Choose 2–5 other players (you are not a column).</div>
        </div>
        <div class="right">
          <button id="closeSetup">Close</button>
        </div>
      </header>
      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>Active players (2–5)</label>
            <select id="selActive">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5" selected>5</option>
            </select>
            <div style="color:var(--muted); font-size:12px; margin-top:8px; font-weight:700">
              Unused player slots will be greyed out.
            </div>
          </div>

          <div class="field">
            <label>Player names (up to 5)</label>
            <div style="display:grid; grid-template-columns:1fr; gap:8px;">
              <input id="p1" placeholder="Player 1 name" />
              <input id="p2" placeholder="Player 2 name" />
              <input id="p3" placeholder="Player 3 name" />
              <input id="p4" placeholder="Player 4 name" />
              <input id="p5" placeholder="Player 5 name" />
            </div>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="danger" id="btnClearAll">Clear Everything</button>
        <button class="primary" id="btnSaveSetup">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Lists Modal -->
  <div class="overlay" id="overlayLists">
    <div class="modal">
      <header>
        <div class="left">
          <div class="title">Lists</div>
          <div class="sub">One name per line (People / Items / Rooms).</div>
        </div>
        <div class="right">
          <button id="closeLists">Close</button>
        </div>
      </header>

      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>WHO?</label>
            <textarea id="taPeople"></textarea>
          </div>
          <div class="field">
            <label>WHAT?</label>
            <textarea id="taItems"></textarea>
          </div>
          <div class="field">
            <label>WHERE?</label>
            <textarea id="taRooms"></textarea>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="primary" id="btnSaveLists">Save Lists</button>
      </div>
    </div>
  </div>

  <!-- Cell Popup -->
  <div class="popup" id="popup">
    <div class="popupCard">
      <div class="popupTop">
        <div class="meta">
          <div id="popTitle" style="font-weight:900; color:var(--blue)">Edit</div>
          <div class="small" id="popSub">Choose a mark</div>
        </div>
        <button id="popClose">Close</button>
      </div>

      <div class="popupBtns">
        <button class="bigBtn bigX" id="popX">❌ X</button>
        <button class="bigBtn bigC" id="popC">✅ Check</button>
        <button class="bigBtn bigQ" id="popQ">❓ Question</button>
        <button class="bigBtn bigClr" id="popClr">⬜ Clear</button>
      </div>

      <div class="popupFoot">
        <button class="danger" id="popClearRow">Clear Row</button>
        <button id="popCancel">Cancel</button>
      </div>
    </div>
  </div>

<script>
/** ====== PWA: register offline service worker ====== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/** ====== Storage ====== */
const KEY = "digital_clue_sheet_v1";

const defaultState = () => ({
  activePlayers: 5, // 2..5
  players: ["Player 1", "Player 2", "Player 3", "Player 4", "Player 5"],
  lists: {
    people: ["Green","Mustard","Orchid","Peacock","Plum","Scarlett"],
    items: ["Candlestick","Dagger","Lead Pipe","Revolver","Rope","Wrench"],
    rooms: ["Ballroom","Billiard Room","Conservatory","Dining Room","Hall","Kitchen","Library","Lounge","Study"]
  },
  // marks[section][rowIndex][playerIndex] = 0 blank, 1 X, 2 check, 3 ?
  marks: { people: [], items: [], rooms: [] },
  found: { peopleIndex: null }
});

function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return defaultState();
    const obj = JSON.parse(raw);
    return sanitize(obj);
  }catch(e){
    return defaultState();
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function sanitize(obj){
  const s = defaultState();
  if(obj && typeof obj === "object"){
    if(Number.isInteger(obj.activePlayers)) s.activePlayers = clamp(obj.activePlayers,2,5);
    if(Array.isArray(obj.players)) s.players = [...s.players].map((_,i)=> String(obj.players[i] ?? s.players[i]).trim() || s.players[i]);
    if(obj.lists && typeof obj.lists==="object"){
      for(const k of ["people","items","rooms"]){
        if(Array.isArray(obj.lists[k]) && obj.lists[k].length){
          s.lists[k] = obj.lists[k].map(x=>String(x).trim()).filter(Boolean);
        }
      }
    }
    if(obj.marks && typeof obj.marks==="object") s.marks = obj.marks;
  }
  ensureMarksShape(s, "people");
  ensureMarksShape(s, "items");
  ensureMarksShape(s, "rooms");
  s.found.peopleIndex = null;
  return s;
}

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

let state = load();

function ensureMarksShape(st, section){
  const rows = st.lists[section].length;
  if(!Array.isArray(st.marks[section])) st.marks[section] = [];
  for(let r=0;r<rows;r++){
    if(!Array.isArray(st.marks[section][r])) st.marks[section][r] = [];
    for(let p=0;p<5;p++){
      const v = st.marks[section][r][p];
      st.marks[section][r][p] = [0,1,2,3].includes(v) ? v : 0;
    }
  }
  st.marks[section] = st.marks[section].slice(0, rows);
}

function markToText(v){
  if(v===1) return "X";
  if(v===2) return "✓";
  if(v===3) return "?";
  return "";
}
function markClass(v){
  if(v===1) return "markX";
  if(v===2) return "markC";
  if(v===3) return "markQ";
  return "";
}

const wrapPeople = document.getElementById("wrapPeople");
const wrapItems  = document.getElementById("wrapItems");
const wrapRooms  = document.getElementById("wrapRooms");
const banner     = document.getElementById("banner");

function renderAll(){
  ensureMarksShape(state,"people");
  ensureMarksShape(state,"items");
  ensureMarksShape(state,"rooms");
  computeFoundKiller();

  banner.style.display = (state.found.peopleIndex !== null) ? "block" : "none";

  wrapPeople.innerHTML = renderSection("people", "WHO?", "Mark X when a player can’t have that person.");
  wrapItems.innerHTML  = renderSection("items",  "WHAT?", "Use ✓ if you know a player has it.");
  wrapRooms.innerHTML  = renderSection("rooms",  "WHERE?", "Use ? if you’re unsure.");

  save();
}

function renderSection(section, title, hint){
  const rows = state.lists[section];
  const active = state.activePlayers;
  const foundIdx = (section==="people") ? state.found.peopleIndex : null;

  let html = `
    <div class="sectionHead">
      <h2>${title}</h2>
      <div class="hint">${hint}</div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>PLAYERS</th>
          ${[0,1,2,3,4].map(i=>{
            const nm = escapeHtml(state.players[i] || `Player ${i+1}`);
            const disabled = i >= active ? " colDisabled" : "";
            return `<th class="${disabled}">${nm}</th>`;
          }).join("")}
        </tr>
      </thead>
      <tbody>
        ${rows.map((rowName, rIdx)=>{
          const isFound = (foundIdx === rIdx && section==="people");
          const grey = (foundIdx !== null && section==="people" && foundIdx !== rIdx) ? " greyOther" : "";
          return `
            <tr class="${isFound ? "foundRow" : ""}${grey}">
              <td>
                <div class="nameCell">
                  <span>${escapeHtml(rowName)}</span>
                  ${isFound ? `<span class="pill">SOLVED</span>` : ``}
                </div>
              </td>
              ${[0,1,2,3,4].map(pIdx=>{
                const disabled = pIdx >= active;
                const v = state.marks[section][rIdx][pIdx];
                const cls = disabled ? "colDisabled" : "";
                const btnCls = "cellBtn " + markClass(v);
                const disAttr = disabled ? "disabled" : "";
                return `
                  <td class="${cls}">
                    <button class="${btnCls}" ${disAttr}
                      data-section="${section}" data-row="${rIdx}" data-player="${pIdx}">
                      ${markToText(v)}
                    </button>
                  </td>
                `;
              }).join("")}
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
  return html;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function computeFoundKiller(){
  const active = state.activePlayers;
  state.found.peopleIndex = null;

  for(let r=0; r<state.lists.people.length; r++){
    let allX = true;
    for(let p=0; p<active; p++){
      if(state.marks.people[r][p] !== 1){
        allX = false; break;
      }
    }
    if(allX){
      state.found.peopleIndex = r;
      break;
    }
  }
}

/* Popup */
const popup = document.getElementById("popup");
const popTitle = document.getElementById("popTitle");
const popSub = document.getElementById("popSub");
let currentCell = null;

function openPopup(section,row,player){
  const rowName = state.lists[section][row];
  const playerName = state.players[player];
  currentCell = {section,row,player};
  popTitle.textContent = `${rowName}`;
  popSub.textContent = `Mark for: ${playerName} (${section.toUpperCase()})`;
  popup.style.display = "flex";
}
function closePopup(){ popup.style.display = "none"; currentCell = null; }

function setCell(value){
  if(!currentCell) return;
  const {section,row,player} = currentCell;
  state.marks[section][row][player] = value;
  closePopup();
  renderAll();
}
function clearRow(){
  if(!currentCell) return;
  const {section,row} = currentCell;
  for(let p=0;p<5;p++) state.marks[section][row][p] = 0;
  closePopup();
  renderAll();
}

document.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  if(btn.dataset && btn.dataset.section){
    const section = btn.dataset.section;
    const row = Number(btn.dataset.row);
    const player = Number(btn.dataset.player);
    if(player >= state.activePlayers) return;
    openPopup(section,row,player);
  }
});

document.getElementById("popX").addEventListener("click", ()=>setCell(1));
document.getElementById("popC").addEventListener("click", ()=>setCell(2));
document.getElementById("popQ").addEventListener("click", ()=>setCell(3));
document.getElementById("popClr").addEventListener("click", ()=>setCell(0));
document.getElementById("popClearRow").addEventListener("click", clearRow);
document.getElementById("popCancel").addEventListener("click", closePopup);
document.getElementById("popClose").addEventListener("click", closePopup);
popup.addEventListener("click", (e)=>{ if(e.target === popup) closePopup(); });

/* Setup modal */
const overlaySetup = document.getElementById("overlaySetup");
document.getElementById("btnSetup").addEventListener("click", ()=>{
  document.getElementById("selActive").value = String(state.activePlayers);
  ["p1","p2","p3","p4","p5"].forEach((id,i)=>{
    document.getElementById(id).value = state.players[i] || `Player ${i+1}`;
  });
  overlaySetup.style.display = "flex";
});
document.getElementById("closeSetup").addEventListener("click", ()=> overlaySetup.style.display="none");
overlaySetup.addEventListener("click", (e)=>{ if(e.target === overlaySetup) overlaySetup.style.display="none"; });

document.getElementById("btnSaveSetup").addEventListener("click", ()=>{
  state.activePlayers = clamp(Number(document.getElementById("selActive").value), 2, 5);
  state.players = ["p1","p2","p3","p4","p5"].map((id,i)=>{
    const v = document.getElementById(id).value.trim();
    return v || `Player ${i+1}`;
  });
  overlaySetup.style.display="none";
  renderAll();
});

document.getElementById("btnClearAll").addEventListener("click", ()=>{
  state = defaultState();
  save();
  overlaySetup.style.display="none";
  renderAll();
});

/* Lists modal */
const overlayLists = document.getElementById("overlayLists");
document.getElementById("btnEditLists").addEventListener("click", ()=>{
  document.getElementById("taPeople").value = state.lists.people.join("\n");
  document.getElementById("taItems").value  = state.lists.items.join("\n");
  document.getElementById("taRooms").value  = state.lists.rooms.join("\n");
  overlayLists.style.display = "flex";
});
document.getElementById("closeLists").addEventListener("click", ()=> overlayLists.style.display="none");
overlayLists.addEventListener("click", (e)=>{ if(e.target === overlayLists) overlayLists.style.display="none"; });

document.getElementById("btnSaveLists").addEventListener("click", ()=>{
  const people = document.getElementById("taPeople").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const items  = document.getElementById("taItems").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const rooms  = document.getElementById("taRooms").value.split("\n").map(s=>s.trim()).filter(Boolean);

  if(people.length) state.lists.people = people;
  if(items.length)  state.lists.items  = items;
  if(rooms.length)  state.lists.rooms  = rooms;

  ensureMarksShape(state,"people");
  ensureMarksShape(state,"items");
  ensureMarksShape(state,"rooms");

  overlayLists.style.display="none";
  renderAll();
});

/* Reset marks */
document.getElementById("btnResetMarks").addEventListener("click", ()=>{
  for(const sec of ["people","items","rooms"]){
    ensureMarksShape(state,sec);
    for(let r=0; r<state.lists[sec].length; r++){
      for(let p=0; p<5; p++) state.marks[sec][r][p] = 0;
    }
  }
  state.found.peopleIndex = null;
  renderAll();
});

renderAll();
</script>
</body>
</html>
