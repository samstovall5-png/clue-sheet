<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detective Notes</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#2f5ea8">

  <style>
    :root{
      --blue:#2f5ea8;
      --blue2:#3b73c8;
      --blue3:#dbe9ff;
      --line:#8fb0e6;
      --paper:#ffffff;
      --text:#0b1b36;
      --muted:#385a8f;
      --danger:#d83a3a;
      --warn:#c08a00;
      --good:#167a2e;
      --shadow: 0 10px 26px rgba(20,60,120,.15);
      --tabH:44px;
      --topbarH:62px;
      --playerH:44px;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(180deg, #f7fbff, #eef5ff 55%, #f7fbff);
      color:var(--text);
      overflow:hidden;
    }

    /* Top bar */
    header{
      position:fixed; top:0; left:0; right:0; z-index:20;
      height:var(--topbarH);
      background:linear-gradient(180deg, var(--blue2), var(--blue));
      color:white;
      border-bottom:2px solid #244e8a;
      padding:10px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    header .title{font-weight:900; letter-spacing:.3px}
    header .sub{color:rgba(255,255,255,.85); font-size:12px}
    header .left{display:flex; flex-direction:column}
    header .right{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    button{
      border:1px solid rgba(255,255,255,.45);
      background:rgba(255,255,255,.14);
      color:white;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
    }
    button:hover{background:rgba(255,255,255,.22)}
    button.primary{
      background:rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.65);
    }
    button.danger{
      background:rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.65);
    }

    /* Layout */
    main{
      position:fixed;
      top:var(--topbarH);
      left:0; right:0; bottom:0;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .banner{
      display:none;
      border:2px solid #2f7a3a;
      background:#eaf7ee;
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      color:var(--text);
      flex:0 0 auto;
    }
    .banner strong{color:var(--good)}
    .banner .muted{color:var(--muted); font-size:12px; margin-top:4px; font-weight:700}

    .card{
      border:2px solid var(--line);
      border-radius:10px;
      overflow:hidden;
      background:var(--paper);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      flex:1 1 auto;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:6px;
      padding:8px;
      border-bottom:2px solid var(--line);
      background:linear-gradient(180deg, var(--blue3), #f5f9ff);
      flex:0 0 auto;
    }
    .tab{
      flex:1 1 0;
      height:var(--tabH);
      border-radius:10px;
      border:2px solid var(--line);
      background:white;
      color:var(--blue);
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{
      background:linear-gradient(180deg, var(--blue2), var(--blue));
      border-color:#244e8a;
      color:white;
    }

    /* Single player header row */
    .playerHeader{
      display:grid;
      grid-template-columns: 34% repeat(5, 1fr);
      align-items:stretch;
      border-bottom:2px solid var(--line);
      background:linear-gradient(180deg, #d2e4ff, #f0f6ff);
      height:var(--playerH);
      flex:0 0 auto;
    }
    .phCell{
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      color:var(--blue);
      border-right:1px solid var(--line);
      padding:0 6px;
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .phCell:first-child{
      justify-content:flex-start;
      padding-left:12px;
      background:#f6faff;
      color:var(--blue);
      font-size:12px;
      letter-spacing:.35px;
    }
    .phCell:last-child{border-right:none}
    .phCell.disabled{
      background:#f0f0f0;
      color:#9aa6b7;
    }

    /* Scroll inside sheet only */
    .sheet{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1 1 auto;
      min-height:0;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:10px 8px;
      text-align:center;
      font-size:14px;
      background:white;
    }
    td:last-child{border-right:none}
    td:first-child{
      text-align:left;
      padding-left:12px;
      width:34%;
      font-weight:900;
      color:var(--blue);
      background:#f6faff;
    }

    .rowLabel{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:white;
      font-weight:900;
      white-space:nowrap;
    }
    .pill.solved{
      border-color:#2f7a3a;
      color:var(--good);
      background:#eaf7ee;
    }

    .cellBtn{
      width:100%;
      border-radius:6px;
      border:1px solid #b7cdf3;
      background:white;
      padding:10px 0;
      cursor:pointer;
      color:var(--blue);
      font-weight:900;
      letter-spacing:.4px;
      user-select:none;
      min-height:40px;
    }
    .cellBtn:hover{background:#f4f8ff}
    .markX{color:var(--danger); border-color:#f0b2b2; background:#fff4f4}
    .markC{color:var(--good); border-color:#b7e1c1; background:#f0fbf3}
    .markQ{color:var(--warn); border-color:#f0d7a0; background:#fff9ea}

    .colDisabled{
      background:#f0f0f0 !important;
      color:#9aa6b7;
    }
    .colDisabled .cellBtn{
      cursor:not-allowed;
      background:#f0f0f0;
      border-color:#d6dbe4;
      color:#9aa6b7;
    }
    .colDisabled .cellBtn:hover{background:#f0f0f0}

    /* Solved highlighting per section */
    tr.greyOther{opacity:.45; filter:saturate(.65);}
    tr.foundRow td:first-child{background:#f0fbf3;}
    tr.foundRow td:first-child .pill{border-color:#2f7a3a;color:var(--good);background:#eaf7ee;}

    /* Overlays / Modals */
    .overlay{
      position:fixed; inset:0; background:rgba(22,50,95,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      background:white;
      border:2px solid var(--line);
      border-radius:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      height:auto;
      background:linear-gradient(180deg, var(--blue2), var(--blue));
      border-bottom:2px solid #244e8a;
    }
    .modal header .title{color:white}
    .modal header .sub{color:rgba(255,255,255,.85)}
    .modalBody{padding:14px}
    .row{
      display:flex; gap:12px; flex-wrap:wrap; margin:10px 0;
      align-items:flex-start;
    }
    .field{
      flex:1 1 220px;
      background:#f5f9ff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:900}
    input, textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:white;
      color:var(--text);
      outline:none;
      font-size:14px;
      font-weight:800;
    }
    textarea{min-height:130px; resize:vertical}

    .modalFoot{
      padding:12px 14px;
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      border-top:2px solid var(--line);
      background:#f6faff;
    }
    .modalFoot button{
      color:var(--blue);
      background:white;
      border:2px solid var(--line);
    }
    .modalFoot button:hover{background:#f4f8ff}
    .modalFoot button.primary{border-color:var(--blue); color:var(--blue)}
    .modalFoot button.danger{border-color:#d83a3a; color:#d83a3a}

    /* Cell Popup */
    .popup{
      position:fixed; inset:0;
      display:none; align-items:flex-end; justify-content:center;
      z-index:60;
      background:rgba(22,50,95,.35);
      padding:14px;
    }
    .popupCard{
      width:min(520px, 100%);
      border-radius:14px;
      border:2px solid var(--line);
      background:white;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .popupTop{
      padding:12px 14px;
      border-bottom:2px solid var(--line);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      background:linear-gradient(180deg, var(--blue3), #f5f9ff);
    }
    .popupTop .meta{display:flex; flex-direction:column; gap:2px}
    .popupTop .meta .small{color:var(--muted); font-size:12px; font-weight:800}
    .popupTop button{
      color:var(--blue);
      background:white;
      border:2px solid var(--line);
    }
    .popupBtns{
      display:grid; grid-template-columns:repeat(2, 1fr);
      gap:10px; padding:14px;
    }
    .bigBtn{
      padding:14px 12px; border-radius:12px; border:2px solid var(--line);
      background:white;
      cursor:pointer; font-size:16px; font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      color:var(--blue);
    }
    .bigBtn:hover{background:#f4f8ff}
    .bigX{color:var(--danger); border-color:#f0b2b2; background:#fff4f4}
    .bigC{color:var(--good); border-color:#b7e1c1; background:#f0fbf3}
    .bigQ{color:var(--warn); border-color:#f0d7a0; background:#fff9ea}
    .popupFoot{
      padding:12px 14px; border-top:2px solid var(--line);
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      background:#f6faff;
    }
    .popupFoot button{
      color:var(--blue);
      background:white;
      border:2px solid var(--line);
    }
    .popupFoot button.danger{border-color:#d83a3a; color:#d83a3a}
    .popupFoot button:hover{background:#f4f8ff}

    
    /* NEW: horizontal scroll inside sheet so player headers don't smash together on small screens */
    table{ min-width: 760px; }
    .sheet{ overflow:auto; }

    /* NEW: make player header borders more visible */
    .playerHeader{ border-top:1px solid var(--line); }
    .phCell{ border-right:2px solid var(--line); }

    @media (max-width:520px){
      :root{ --topbarH: 92px; }
      header .sub{display:none}
      header{padding:8px 10px;}
      header .right button{padding:8px 10px; font-size:13px; border-radius:9px;}
      header .right{gap:6px;}
      .phCell{font-size:11px;}
      table{min-width:720px;}

    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div class="title">Detective Notes</div>
      <div class="sub">Tap a box → ❌ / ✅ / ❓ • Use “Guess” to record a guess.</div>
    </div>
    <div class="right">
      <button class="primary" id="btnGuess">Guess</button>
      <button class="primary" id="btnSetup">Players</button>
      <button id="btnEditLists">Lists</button>
      <button class="danger" id="btnResetMarks">Reset</button>
    </div>
  </header>

  <main>
    <div class="banner" id="banner"></div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="people">WHO?</button>
        <button class="tab" data-tab="items">WHAT?</button>
        <button class="tab" data-tab="rooms">WHERE?</button>
      </div>

      <div class="playerHeader" id="playerHeader"></div>

      <div class="sheet">
        <div id="tab-people"></div>
        <div id="tab-items" style="display:none"></div>
        <div id="tab-rooms" style="display:none"></div>
      </div>
    </div>
  </main>

  <!-- Guess Modal -->
  <div class="overlay" id="overlayGuess">
    <div class="modal">
      <header>
        <div class="left">
          <div class="title">Make a Guess</div>
          <div class="sub">Pick WHO / WHAT / WHERE, then choose who showed a card (or no one).</div>
        </div>
        <div class="right">
          <button id="closeGuess">Close</button>
        </div>
      </header>

      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>WHO?</label>
            <select id="selGuessWho"></select>
          </div>
          <div class="field">
            <label>WHAT?</label>
            <select id="selGuessWhat"></select>
          </div>
          <div class="field">
            <label>WHERE?</label>
            <select id="selGuessWhere"></select>
          </div>
        </div>

        <div class="row">
          <div class="field" style="flex:1 1 520px">
            <label>Who showed a card?</label>
            <select id="selResponder"></select>
            <div style="color:var(--muted); font-size:12px; margin-top:8px; font-weight:800;">
              • If a player showed a card, we mark ❓ for that player on all 3 choices (since you don’t know which one).<br>
              • If <strong>No one</strong> could show, we mark ❌ for <strong>all active players</strong> on all 3 (meaning they’re in the solution).
            </div>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="danger" id="btnClearGuess">Clear</button>
        <button class="primary" id="btnApplyGuess">Apply</button>
      </div>
    </div>
  </div>


  <!-- Shown Card Modal -->
  <div class="overlay" id="overlayShown">
    <div class="modal">
      <header>
        <div class="left">
          <div class="title">What was shown?</div>
          <div class="sub">Pick the exact card that was shown to you.</div>
        </div>
        <div class="right">
          <button id="closeShown">Close</button>
        </div>
      </header>

      <div class="modalBody">
        <div class="row">
          <div class="field" style="flex:1 1 520px">
            <label>Card shown</label>
            <select id="selShownCard"></select>
            <div style="color:var(--muted); font-size:12px; margin-top:8px; font-weight:800;">
              If you don’t know which card, choose <strong>Unknown</strong> and we’ll mark ❓ on all 3 like before.
            </div>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="danger" id="btnUnknownShown">Unknown</button>
        <button class="primary" id="btnConfirmShown">Confirm</button>
      </div>
    </div>
  </div>


  <!-- Setup Modal -->
  <div class="overlay" id="overlaySetup">
    <div class="modal">
      <header>
        <div class="left">
          <div class="title">Players</div>
          <div class="sub">Choose 2–5 other players (you are not a column).</div>
        </div>
        <div class="right">
          <button id="closeSetup">Close</button>
        </div>
      </header>
      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>Active players (2–5)</label>
            <select id="selActive">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5" selected>5</option>
            </select>
          </div>

          <div class="field">
            <label>Player names (up to 5)</label>
            <div style="display:grid; grid-template-columns:1fr; gap:8px;">
              <input id="p1" placeholder="Player 1 name" />
              <input id="p2" placeholder="Player 2 name" />
              <input id="p3" placeholder="Player 3 name" />
              <input id="p4" placeholder="Player 4 name" />
              <input id="p5" placeholder="Player 5 name" />
            </div>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="danger" id="btnClearAll">Clear Everything</button>
        <button class="primary" id="btnSaveSetup">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Lists Modal -->
  <div class="overlay" id="overlayLists">
    <div class="modal">
      <header>
        <div class="left">
          <div class="title">Lists</div>
          <div class="sub">One name per line (WHO / WHAT / WHERE).</div>
        </div>
        <div class="right">
          <button id="closeLists">Close</button>
        </div>
      </header>

      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>WHO?</label>
            <textarea id="taPeople"></textarea>
          </div>
          <div class="field">
            <label>WHAT?</label>
            <textarea id="taItems"></textarea>
          </div>
          <div class="field">
            <label>WHERE?</label>
            <textarea id="taRooms"></textarea>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="primary" id="btnSaveLists">Save Lists</button>
      </div>
    </div>
  </div>

  <!-- Cell Popup -->
  <div class="popup" id="popup">
    <div class="popupCard">
      <div class="popupTop">
        <div class="meta">
          <div id="popTitle" style="font-weight:900; color:var(--blue)">Edit</div>
          <div class="small" id="popSub">Choose a mark</div>
        </div>
        <button id="popClose">Close</button>
      </div>

      <div class="popupBtns">
        <button class="bigBtn bigX" id="popX">❌ X</button>
        <button class="bigBtn bigC" id="popC">✅ Check</button>
        <button class="bigBtn bigQ" id="popQ">❓ Question</button>
        <button class="bigBtn" id="popClr">⬜ Clear</button>
      </div>

      <div class="popupFoot">
        <button class="danger" id="popClearRow">Clear Row</button>
        <button id="popCancel">Cancel</button>
      </div>
    </div>
  </div>

<script>
/** PWA */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/** Storage */
const KEY = "digital_clue_sheet_v4_blue_guessmodal";
const defaultState = () => ({
  activePlayers: 5,
  players: ["Player 1","Player 2","Player 3","Player 4","Player 5"],
  lists: {
    people: ["Green","Mustard","Orchid","Peacock","Plum","Scarlett"],
    items: ["Candlestick","Dagger","Lead Pipe","Revolver","Rope","Wrench"],
    rooms: ["Ballroom","Billiard Room","Conservatory","Dining Room","Hall","Kitchen","Library","Lounge","Study"]
  },
  marks: { people: [], items: [], rooms: [] }
});

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return defaultState();
    return sanitize(JSON.parse(raw));
  }catch(e){ return defaultState(); }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function sanitize(obj){
  const s = defaultState();
  if(obj && typeof obj === "object"){
    if(Number.isInteger(obj.activePlayers)) s.activePlayers = clamp(obj.activePlayers,2,5);
    if(Array.isArray(obj.players)) s.players = [...s.players].map((_,i)=> String(obj.players[i] ?? s.players[i]).trim() || s.players[i]);
    if(obj.lists && typeof obj.lists==="object"){
      for(const k of ["people","items","rooms"]){
        if(Array.isArray(obj.lists[k]) && obj.lists[k].length){
          s.lists[k] = obj.lists[k].map(x=>String(x).trim()).filter(Boolean);
        }
      }
    }
    if(obj.marks && typeof obj.marks==="object") s.marks = obj.marks;
  }
  ensureMarksShape(s,"people"); ensureMarksShape(s,"items"); ensureMarksShape(s,"rooms");
  return s;
}

let state = load();

/** Marks */
function ensureMarksShape(st, section){
  const rows = st.lists[section].length;
  if(!Array.isArray(st.marks[section])) st.marks[section] = [];
  for(let r=0;r<rows;r++){
    if(!Array.isArray(st.marks[section][r])) st.marks[section][r] = [];
    for(let p=0;p<5;p++){
      const v = st.marks[section][r][p];
      st.marks[section][r][p] = [0,1,2,3].includes(v) ? v : 0;
    }
  }
  st.marks[section] = st.marks[section].slice(0, rows);
}
function markToText(v){ return v===1?"X":(v===2?"✓":(v===3?"?":"")); }
function markClass(v){ return v===1?"markX":(v===2?"markC":(v===3?"markQ":"")); }
function escapeHtml(str){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/** UI refs */
const banner = document.getElementById("banner");
const playerHeader = document.getElementById("playerHeader");
const tabPeople = document.getElementById("tab-people");
const tabItems  = document.getElementById("tab-items");
const tabRooms  = document.getElementById("tab-rooms");
const tabs = Array.from(document.querySelectorAll(".tab"));

/** Guess modal refs */
const overlayGuess = document.getElementById("overlayGuess");
const selGuessWho   = document.getElementById("selGuessWho");
const selGuessWhat  = document.getElementById("selGuessWhat");
const selGuessWhere = document.getElementById("selGuessWhere");
const selResponder  = document.getElementById("selResponder");


/** Shown card modal refs */
const overlayShown = document.getElementById("overlayShown");
const selShownCard = document.getElementById("selShownCard");
let pendingGuess = null; // {whoIdx, whatIdx, whereIdx, player}

/** Shown modal open/close */
function openShown(guess){
  pendingGuess = guess;
  // Build options: Unknown + three choices labeled by category
  const whoName = state.lists.people[guess.whoIdx];
  const whatName = state.lists.items[guess.whatIdx];
  const whereName = state.lists.rooms[guess.whereIdx];

  selShownCard.innerHTML = `
    <option value="unknown">Unknown</option>
    <option value="people">${escapeHtml("WHO: " + whoName)}</option>
    <option value="items">${escapeHtml("WHAT: " + whatName)}</option>
    <option value="rooms">${escapeHtml("WHERE: " + whereName)}</option>
  `;
  selShownCard.value = "unknown";
  overlayShown.style.display = "flex";
}
function closeShown(){
  overlayShown.style.display = "none";
  pendingGuess = null;
}


/** Render pieces */
function renderPlayerHeader(){
  const active = state.activePlayers;
  const cells = [];
  cells.push(`<div class="phCell">PLAYERS</div>`);
  for(let i=0;i<5;i++){
    const disabled = i>=active ? " disabled" : "";
    cells.push(`<div class="phCell${disabled}">${escapeHtml(state.players[i] || ("Player "+(i+1)))}</div>`);
  }
  playerHeader.innerHTML = cells.join("");
}

function computeSolved(section){
  const active = state.activePlayers;
  const solved = [];
  for(let r=0; r<state.lists[section].length; r++){
    let allX = true;
    for(let p=0; p<active; p++){
      if(state.marks[section][r][p] !== 1){ allX = false; break; }
    }
    if(allX) solved.push(r);
  }
  return solved;
}

function updateBanner(solved){
  const parts = [];
  if(solved.people.length) parts.push(`WHO: <strong>${escapeHtml(state.lists.people[solved.people[0]])}</strong>`);
  if(solved.items.length)  parts.push(`WHAT: <strong>${escapeHtml(state.lists.items[solved.items[0]])}</strong>`);
  if(solved.rooms.length)  parts.push(`WHERE: <strong>${escapeHtml(state.lists.rooms[solved.rooms[0]])}</strong>`);

  if(parts.length === 0){
    banner.style.display = "none";
    banner.innerHTML = "";
    return;
  }

  banner.style.display = "block";
  if(parts.length === 3){
    banner.innerHTML = `<div><strong>✅ Case solved!</strong> ${parts.join(" • ")}</div>
      <div class="muted">(Each solved row is X for all active players.)</div>`;
  }else{
    banner.innerHTML = `<div><strong>✅ Discovery!</strong> ${parts.join(" • ")}</div>
      <div class="muted">(A row became X for all active players.)</div>`;
  }
}

function renderSection(section, solved){
  const rows = state.lists[section];
  const active = state.activePlayers;

  const solvedMain = (solved.length === 1) ? solved[0] : null;

  let html = `<table><tbody>`;
  rows.forEach((name, rIdx)=>{
    const isFound = (solvedMain !== null && solvedMain === rIdx);
    const grey = (solvedMain !== null && solvedMain !== rIdx) ? " greyOther" : "";
    const trCls = (isFound ? "foundRow" : "") + grey;

    html += `<tr class="${trCls.trim()}">`;
    html += `<td><div class="rowLabel"><span>${escapeHtml(name)}</span>${isFound?`<span class="pill solved">SOLVED</span>`:""}</div></td>`;

    for(let pIdx=0;pIdx<5;pIdx++){
      const disabled = pIdx>=active;
      const v = state.marks[section][rIdx][pIdx];
      const tdCls = disabled ? "colDisabled" : "";
      const disAttr = disabled ? "disabled" : "";
      html += `<td class="${tdCls}">
        <button class="cellBtn ${markClass(v)}" ${disAttr}
          data-section="${section}" data-row="${rIdx}" data-player="${pIdx}">
          ${markToText(v)}
        </button>
      </td>`;
    }
    html += `</tr>`;
  });
  html += `</tbody></table>`;
  return html;
}

function fillSelectOptions(selectEl, items){
  const prev = selectEl.value;
  selectEl.innerHTML = items.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
  if(items.includes(prev)) selectEl.value = prev;
}

function renderGuessModal(){
  fillSelectOptions(selGuessWho, state.lists.people);
  fillSelectOptions(selGuessWhat, state.lists.items);
  fillSelectOptions(selGuessWhere, state.lists.rooms);

  const active = state.activePlayers;
  let opts = `<option value="none">No one (solution)</option>`;
  for(let i=0;i<active;i++){
    opts += `<option value="${i}">${escapeHtml(state.players[i])}</option>`;
  }
  selResponder.innerHTML = opts;
  if(!selResponder.value) selResponder.value = "none";
}

function applyGuess(){
  const who = selGuessWho.value;
  const what = selGuessWhat.value;
  const where = selGuessWhere.value;
  const resp = selResponder.value;

  const whoIdx = state.lists.people.indexOf(who);
  const whatIdx = state.lists.items.indexOf(what);
  const whereIdx = state.lists.rooms.indexOf(where);
  if(whoIdx < 0 || whatIdx < 0 || whereIdx < 0) return;

  if(resp === "none"){
    // No one could show => all three are in the solution
    for(const sec of ["people","items","rooms"]){
      const idx = (sec==="people")?whoIdx : (sec==="items")?whatIdx : whereIdx;
      for(let p=0;p<state.activePlayers;p++){
        state.marks[sec][idx][p] = 1; // X
      }
    }
    renderAll();
    closeGuess();
    return;
  }

  // A player showed you a card. Ask WHICH card.
  const p = Number(resp);
  openShown({ whoIdx, whatIdx, whereIdx, player: p });
}

function clearGuess(){
  selResponder.value = "none";
}


function unknownShown(){
  // mark ? on all 3 for that player (only if blank)
  if(!pendingGuess) return;
  const p = pendingGuess.player;
  const setQ = (sec, idx) => {
    const cur = state.marks[sec][idx][p];
    if(cur === 0) state.marks[sec][idx][p] = 3;
  };
  setQ("people", pendingGuess.whoIdx);
  setQ("items",  pendingGuess.whatIdx);
  setQ("rooms",  pendingGuess.whereIdx);

  closeShown();
  renderAll();
  closeGuess();
}

function confirmShown(){
  if(!pendingGuess) return;
  const p = pendingGuess.player;
  const chosen = selShownCard.value;

  if(chosen === "unknown"){
    unknownShown();
    return;
  }

  // Put a CHECK on the exact card that was shown under that player's column
  const setCheck = (sec, idx) => { state.marks[sec][idx][p] = 2; }; // ✓
  if(chosen === "people") setCheck("people", pendingGuess.whoIdx);
  if(chosen === "items")  setCheck("items",  pendingGuess.whatIdx);
  if(chosen === "rooms")  setCheck("rooms",  pendingGuess.whereIdx);

  closeShown();
  renderAll();
  closeGuess();
}


function renderAll(){
  ensureMarksShape(state,"people"); ensureMarksShape(state,"items"); ensureMarksShape(state,"rooms");

  const solved = {
    people: computeSolved("people"),
    items:  computeSolved("items"),
    rooms:  computeSolved("rooms")
  };
  updateBanner(solved);

  renderPlayerHeader();
  renderGuessModal();

  tabPeople.innerHTML = renderSection("people", solved.people);
  tabItems.innerHTML  = renderSection("items",  solved.items);
  tabRooms.innerHTML  = renderSection("rooms",  solved.rooms);

  save();
}

/** Tabs */
function showTab(which){
  tabPeople.style.display = (which==="people") ? "block" : "none";
  tabItems.style.display  = (which==="items")  ? "block" : "none";
  tabRooms.style.display  = (which==="rooms")  ? "block" : "none";
  tabs.forEach(t => t.classList.toggle("active", t.dataset.tab===which));
  document.querySelector(".sheet").scrollTop = 0;
}

/** Guess modal open/close */
function openGuess(){
  renderGuessModal();
  overlayGuess.style.display = "flex";
}
function closeGuess(){
  overlayGuess.style.display = "none";
}

/** Cell popup */
const popup = document.getElementById("popup");
const popTitle = document.getElementById("popTitle");
const popSub = document.getElementById("popSub");
let currentCell = null;

function openPopup(section,row,player){
  currentCell = {section,row,player};
  popTitle.textContent = state.lists[section][row];
  popSub.textContent = "Mark for: " + state.players[player] + " (" + section.toUpperCase() + ")";
  popup.style.display = "flex";
}
function closePopup(){ popup.style.display="none"; currentCell=null; }
function setCell(value){
  if(!currentCell) return;
  const {section,row,player} = currentCell;
  state.marks[section][row][player] = value;
  closePopup();
  renderAll();
}
function clearRow(){
  if(!currentCell) return;
  const {section,row} = currentCell;
  for(let p=0;p<5;p++) state.marks[section][row][p]=0;
  closePopup();
  renderAll();
}

/** Global clicks */
document.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  if(btn.classList.contains("tab")){
    showTab(btn.dataset.tab);
    return;
  }

  if(btn.id === "btnGuess"){ openGuess(); return; }
  if(btn.id === "btnApplyGuess"){ applyGuess(); return; }
  if(btn.id === "btnClearGuess"){ clearGuess(); return; }
  if(btn.id === "closeGuess"){ closeGuess(); return; }
  if(btn.id === "closeShown"){ closeShown(); return; }
  if(btn.id === "btnConfirmShown"){ confirmShown(); return; }
  if(btn.id === "btnUnknownShown"){ unknownShown(); return; }

  if(btn.dataset && btn.dataset.section){
    const section = btn.dataset.section;
    const row = Number(btn.dataset.row);
    const player = Number(btn.dataset.player);
    if(player >= state.activePlayers) return;
    openPopup(section,row,player);
  }
});

/** Overlay background clicks */
overlayGuess.addEventListener("click", (e)=>{ if(e.target === overlayGuess) closeGuess(); });
overlayShown.addEventListener("click", (e)=>{ if(e.target === overlayShown) closeShown(); });

/** Popup buttons */
document.getElementById("popX").addEventListener("click", ()=>setCell(1));
document.getElementById("popC").addEventListener("click", ()=>setCell(2));
document.getElementById("popQ").addEventListener("click", ()=>setCell(3));
document.getElementById("popClr").addEventListener("click", ()=>setCell(0));
document.getElementById("popClearRow").addEventListener("click", clearRow);
document.getElementById("popCancel").addEventListener("click", closePopup);
document.getElementById("popClose").addEventListener("click", closePopup);
popup.addEventListener("click", (e)=>{ if(e.target === popup) closePopup(); });

/** Setup modal */
const overlaySetup = document.getElementById("overlaySetup");
document.getElementById("btnSetup").addEventListener("click", ()=>{
  document.getElementById("selActive").value = String(state.activePlayers);
  ["p1","p2","p3","p4","p5"].forEach((id,i)=>{ document.getElementById(id).value = state.players[i] || ("Player "+(i+1)); });
  overlaySetup.style.display="flex";
});
document.getElementById("closeSetup").addEventListener("click", ()=> overlaySetup.style.display="none");
overlaySetup.addEventListener("click", (e)=>{ if(e.target === overlaySetup) overlaySetup.style.display="none"; });

document.getElementById("btnSaveSetup").addEventListener("click", ()=>{
  state.activePlayers = clamp(Number(document.getElementById("selActive").value),2,5);
  state.players = ["p1","p2","p3","p4","p5"].map((id,i)=>{
    const v = document.getElementById(id).value.trim();
    return v || ("Player "+(i+1));
  });
  overlaySetup.style.display="none";
  renderAll();
});

document.getElementById("btnClearAll").addEventListener("click", ()=>{
  state = defaultState();
  overlaySetup.style.display="none";
  renderAll();
});

/** Lists modal */
const overlayLists = document.getElementById("overlayLists");
document.getElementById("btnEditLists").addEventListener("click", ()=>{
  document.getElementById("taPeople").value = state.lists.people.join("\n");
  document.getElementById("taItems").value  = state.lists.items.join("\n");
  document.getElementById("taRooms").value  = state.lists.rooms.join("\n");
  overlayLists.style.display="flex";
});
document.getElementById("closeLists").addEventListener("click", ()=> overlayLists.style.display="none");
overlayLists.addEventListener("click", (e)=>{ if(e.target === overlayLists) overlayLists.style.display="none"; });

document.getElementById("btnSaveLists").addEventListener("click", ()=>{
  const people = document.getElementById("taPeople").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const items  = document.getElementById("taItems").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const rooms  = document.getElementById("taRooms").value.split("\n").map(s=>s.trim()).filter(Boolean);

  if(people.length) state.lists.people = people;
  if(items.length)  state.lists.items  = items;
  if(rooms.length)  state.lists.rooms  = rooms;

  ensureMarksShape(state,"people"); ensureMarksShape(state,"items"); ensureMarksShape(state,"rooms");

  overlayLists.style.display="none";
  renderAll();
});

/** Reset marks */
document.getElementById("btnResetMarks").addEventListener("click", ()=>{
  for(const sec of ["people","items","rooms"]){
    ensureMarksShape(state,sec);
    for(let r=0;r<state.lists[sec].length;r++){
      for(let p=0;p<5;p++) state.marks[sec][r][p]=0;
    }
  }
  renderAll();
});

/** Init */
renderAll();
showTab("people");
</script>
</body>
</html>
